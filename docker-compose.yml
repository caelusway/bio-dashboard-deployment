version: '3.8'

services:
  backend:
    build:
      context: ./apps/bio-internal
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      PORT: 4100
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_DB_URL: ${SUPABASE_DB_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      TWITTER_BEARER_TOKEN: ${TWITTER_BEARER_TOKEN}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:4100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

  frontend:
    build:
      context: ./apps/bio-dashboard
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://backend:4100}
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
